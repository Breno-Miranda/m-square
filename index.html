<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3QK6CR1BXY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-3QK6CR1BXY');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Square | Video steams square multiScreen</title>
    <meta name="description" content="M-Square: Visualiza√ß√£o simult√¢nea de m√∫ltiplos v√≠deos com design premium.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="floating-logo">
        <span class="logo-icon">üöÄ</span>
        <span class="logo-text">M-SQUARE</span>
    </div>

    <main class="grid-main">
        <div id="videoContainer" class="video-grid">
            <!-- Os v√≠deos ser√£o injetados via JS ou renderizados inicialmente -->
        </div>
    </main>

    <div class="floating-control">
        <button class="btn-settings" onclick="openModal()">
            <span>‚öôÔ∏è</span> Configurar Canais
        </button>
    </div>

    <!-- Modal de Configura√ß√£o -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gerenciar Streams</h3>
                <p style="font-size: 0.7rem; color: #666; margin-top: 5px;">Link completo ou apenas o ID do YouTube</p>
            </div>

            <div class="modal-body-scroll">
                <div class="search-section">
                    <div class="search-bar">
                        <input type="text" id="ytSearchInput" placeholder="Pesquisar v√≠deos ou lives...">
                        <button onclick="searchYouTube()">üîç</button>
                    </div>
                    <div id="searchResults" class="search-results-list"></div>
                </div>

                <div id="inputContainer">
                    <!-- Inputs ser√£o gerados dinamicamente -->
                </div>
                <button class="btn-add-stream" onclick="addStream()">+ Adicionar outro v√≠deo</button>
            </div>
            <div class="modal-footer">
                <button class="btn-api-config" onclick="toggleApiSettings()">üîë API Key</button>
                <div style="flex: 1"></div>
                <button class="btn-close" onclick="closeModal()">Cancelar</button>
                <button class="btn-save" onclick="saveSettings()">Salvar Configura√ß√µes</button>
            </div>
            <div id="apiSettings" class="api-settings-panel" style="display: none;">
                <input type="password" id="ytApiKey" placeholder="Sua YouTube Data API Key" value="">
                <button onclick="saveApiKey()">Salvar Key</button>
            </div>
        </div>
    </div>

    <div class="version-badge">V0.10.42</div>


    <script>
        let players = {};
        let playerIds = [];
        let lastClickTime = 0;

        const defaultVideos = [
            'XWjQEpRrgbE',
            '1kx--gAntwE',
            'krUGzTq00Z0',
            'YGNIRYKBqdc'
        ];

        function initApp() {
            const saved = localStorage.getItem('msquare_streams');
            const streamIds = saved ? JSON.parse(saved) : defaultVideos;
            updateSystemState(streamIds);
        }

        function updateSystemState(ids) {
            // Limpa players antigos antes de re-renderizar
            Object.values(players).forEach(p => {
                if (p && typeof p.destroy === 'function') p.destroy();
            });
            players = {};

            playerIds = ids.map((_, i) => `player${i + 1}`);
            renderGrid(ids);

            // Inicializa novos players. 
            if (typeof YT !== 'undefined' && YT.Player) {
                playerIds.forEach((id, index) => createPlayer(id, ids[index]));
                triggerEntranceAnimation();
            }
        }

        function renderGrid(ids) {
            const container = document.getElementById('videoContainer');
            const borders = ['border-primary', 'border-secondary', 'border-tertiary', 'border-gradient'];

            // Sempre adiciona um slot vazio no final para preencher a grade e convidar a adicionar mais
            const displayIds = [...ids, ""];

            container.innerHTML = displayIds.map((id, index) => {
                const bClass = borders[index % borders.length];

                if (!id || id.trim() === '') {
                    return `
                        <div class="video-item ${bClass} empty-slot" onclick="openModal(true)">
                            <div class="add-icon-wrapper">+</div>
                            <span>Adicionar V√≠deo</span>
                        </div>
                    `;
                }

                return `
                    <div class="video-item ${bClass}" onclick="toggleMute(event, 'player${index + 1}')" ondblclick="toggleFullscreen(event, this)">
                        <button class="btn-delete-video" onclick="removeStreamFromGrid(event, ${index})" title="Remover v√≠deo">‚úï</button>
                        <div class="video-overlay"></div>
                        <div id="player${index + 1}"></div> 
                    </div>
                `;
            }).join('');
        }

        function renderInputs(ids) {
            const container = document.getElementById('inputContainer');
            container.innerHTML = ids.map((id, index) => `
                <div class="input-group">
                    <label>V√≠deo ${index + 1} (Link ou ID)</label>
                    <div class="input-row">
                        <input type="text" class="stream-input" value="${id}" placeholder="Ex: https://www.youtube.com/watch?v=...">
                        ${ids.length > 1 ? `<button class="btn-remove" onclick="removeStream(${index})">üóë</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function addStream() {
            const inputs = document.querySelectorAll('.stream-input');
            const ids = Array.from(inputs).map(i => i.value.trim());
            ids.push('');
            renderInputs(ids);
        }

        function removeStream(index) {
            const inputs = document.querySelectorAll('.stream-input');
            const ids = Array.from(inputs).map(i => i.value.trim());
            ids.splice(index, 1);
            renderInputs(ids);
        }

        function removeStreamFromGrid(e, index) {
            if (e) e.stopPropagation();
            const ids = getSavedIds();
            if (ids.length <= 1) {
                alert('Mantenha pelo menos um v√≠deo na grade.');
                return;
            }
            if (confirm('Deseja remover este v√≠deo da grade?')) {
                ids.splice(index, 1);
                localStorage.setItem('msquare_streams', JSON.stringify(ids));
                updateSystemState(ids);
            }
        }

        function onYouTubeIframeAPIReady() {
            initApp();
            renderInputs(getSavedIds());
        }

        function getSavedIds() {
            const saved = localStorage.getItem('msquare_streams');
            return saved ? JSON.parse(saved) : defaultVideos;
        }

        function createPlayer(elementId, videoId) {
            if (!videoId) return;

            players[elementId] = new YT.Player(elementId, {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,
                    'mute': 1,
                    'enablejsapi': 1,
                    'controls': 0,
                    'rel': 0,
                    'iv_load_policy': 3
                },
                events: {
                    'onReady': (event) => {
                        event.target.mute();
                        event.target.playVideo();
                    },
                    'onStateChange': (event) => {
                        if (event.data === YT.PlayerState.PAUSED) {
                            event.target.playVideo();
                        }
                    }
                }
            });
        }

        function openModal(isAddingNew = false) {
            renderInputs(getSavedIds());
            document.getElementById('settingsModal').style.display = 'flex';

            if (isAddingNew) {
                // Focus na pesquisa para agilizar a adi√ß√£o
                setTimeout(() => {
                    const searchInput = document.getElementById('ytSearchInput');
                    searchInput.focus();
                    searchInput.placeholder = "Digite o nome para o novo v√≠deo...";
                }, 100);
            }
        }

        function closeModal() { document.getElementById('settingsModal').style.display = 'none'; }

        function extractYouTubeId(url) {
            if (!url) return '';
            url = url.trim();

            // Se j√° for um ID de 11 caracteres (padr√£o YouTube)
            if (/^[a-zA-Z0-9_-]{11}$/.test(url)) {
                return url;
            }

            const regexes = [
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/v\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/live\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?youtu\.be\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?m\.youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/
            ];

            for (const regex of regexes) {
                const match = url.match(regex);
                if (match && match[1]) {
                    return match[1];
                }
            }

            // Fallback para URLs complexas com m√∫ltiplos par√¢metros
            try {
                const urlObj = new URL(url.startsWith('http') ? url : 'https://' + url);
                if (urlObj.searchParams.has('v')) {
                    return urlObj.searchParams.get('v');
                }
            } catch (e) { }

            return url;
        }

        async function searchYouTube() {
            const query = document.getElementById('ytSearchInput').value.trim();
            const apiKey = localStorage.getItem('yt_api_key');
            const resultsContainer = document.getElementById('searchResults');

            if (!query) return;
            if (!apiKey) {
                alert('Por favor, configure sua YouTube API Key clicando no √≠cone de chave abaixo.');
                return;
            }

            resultsContainer.innerHTML = '<p style="text-align:center; padding: 10px; font-size: 0.8rem;">Pesquisando...</p>';

            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=5&q=${encodeURIComponent(query)}&type=video&key=${apiKey}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                resultsContainer.innerHTML = data.items.map(item => `
                    <div class="search-result-item" onclick="selectVideo('${item.id.videoId}')">
                        <img src="${item.snippet.thumbnails.default.url}" alt="thumb">
                        <div class="result-info">
                            <span class="result-title">${item.snippet.title}</span>
                            <span class="result-channel">${item.snippet.channelTitle}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                resultsContainer.innerHTML = `<p style="color: #ff4444; font-size: 0.8rem; padding: 10px;">Erro: ${error.message}</p>`;
            }
        }

        function selectVideo(id) {
            // Adiciona o v√≠deo ao primeiro input vazio ou cria um novo
            const inputs = document.querySelectorAll('.stream-input');
            let filled = false;
            for (let input of inputs) {
                if (input.value.trim() === '') {
                    input.value = id;
                    filled = true;
                    break;
                }
            }
            if (!filled) {
                addStream();
                setTimeout(() => {
                    const newInputs = document.querySelectorAll('.stream-input');
                    newInputs[newInputs.length - 1].value = id;
                }, 50);
            }
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('ytSearchInput').value = '';
        }

        function toggleApiSettings() {
            const panel = document.getElementById('apiSettings');
            panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
            if (panel.style.display === 'flex') {
                document.getElementById('ytApiKey').value = localStorage.getItem('yt_api_key') || '';
            }
        }

        function saveApiKey() {
            const key = document.getElementById('ytApiKey').value.trim();
            localStorage.setItem('yt_api_key', key);
            alert('API Key salva com sucesso!');
            toggleApiSettings();
        }

        function saveSettings() {
            const inputs = document.querySelectorAll('.stream-input');
            const newIds = Array.from(inputs)
                .map(i => extractYouTubeId(i.value.trim()))
                .filter(id => id !== '');

            if (newIds.length === 0) {
                alert('Adicione pelo menos um v√≠deo v√°lido.');
                return;
            }

            localStorage.setItem('msquare_streams', JSON.stringify(newIds));
            updateSystemState(newIds);
            closeModal();
        }

        function toggleFullscreen(e, element) {
            if (e) { e.stopPropagation(); }
            const iframe = element.querySelector('iframe');
            if (!document.fullscreenElement) {
                if (element.requestFullscreen) element.requestFullscreen();
                else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();

                if (iframe && players[iframe.id]) {
                    const id = iframe.id;
                    playerIds.forEach(pId => players[pId]?.mute?.());
                    players[id]?.unMute?.();
                    showStatus(id, 'Fullscreen Focus üì∫üîä');
                }
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        function toggleMute(e, id) {
            if (e) { e.stopPropagation(); }
            const now = Date.now();
            if (now - lastClickTime < 300) { lastClickTime = now; return false; }
            lastClickTime = now;

            const targetPlayer = players[id];
            if (!targetPlayer || typeof targetPlayer.isMuted !== 'function') return false;

            const isCurrentlyMuted = targetPlayer.isMuted();
            playerIds.forEach(pId => players[pId]?.mute?.());

            if (isCurrentlyMuted) {
                targetPlayer.unMute();
                targetPlayer.playVideo();
                showStatus(id, 'Audio Focus üîä');
            } else {
                showStatus(id, 'All Muted üîá');
            }
            return false;
        }

        function showStatus(id, text) {
            const container = document.getElementById(id).parentElement;
            let status = container.querySelector('.status-indicator');
            if (!status) {
                status = document.createElement('div');
                status.className = 'status-indicator';
                container.appendChild(status);
            }
            status.textContent = text;
            status.classList.add('visible');
            setTimeout(() => status.classList.remove('visible'), 1500);
        }

        function triggerEntranceAnimation() {
            document.querySelectorAll('.video-item').forEach((item, index) => {
                setTimeout(() => {
                    item.style.opacity = "1";
                    item.style.transform = "scale(1)";
                }, index * 100);
            });
        }
        // For√ßa inicializa√ß√£o caso a API j√° esteja carregada (cache)
        if (window.YT && window.YT.Player) {
            onYouTubeIframeAPIReady();
        }
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
</body>

</html>