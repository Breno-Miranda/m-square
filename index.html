<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3QK6CR1BXY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-3QK6CR1BXY');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Square | Video steams square multiScreen</title>
    <meta name="description" content="M-Square: Visualiza√ß√£o simult√¢nea de m√∫ltiplos v√≠deos com design premium.">
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="floating-logo">
        <span class="logo-icon">üöÄ</span>
        <span class="logo-text">M-SQUARE</span>
    </div>

    <main class="grid-main">
        <div id="videoContainer" class="video-grid">
            <!-- Os v√≠deos ser√£o injetados via JS ou renderizados inicialmente -->
        </div>
    </main>

    <div class="floating-control">
        <button class="btn-settings" onclick="openModal()">
            <span>‚öôÔ∏è</span> Configurar Canais
        </button>
    </div>

    <!-- Modal de Configura√ß√£o -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gerenciar Streams</h3>
                <p style="font-size: 0.7rem; color: #666; margin-top: 5px;">Link completo ou apenas o ID do YouTube</p>
            </div>
            <div id="inputContainer">
                <!-- Inputs ser√£o gerados dinamicamente -->
            </div>
            <button class="btn-add-stream" onclick="addStream()">+ Adicionar outro v√≠deo</button>
            <div class="modal-footer">
                <button class="btn-close" onclick="closeModal()">Cancelar</button>
                <button class="btn-save" onclick="saveSettings()">Salvar Configura√ß√µes</button>
            </div>
        </div>
    </div>

    <div class="version-badge">V0.10.31</div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let players = {};
        let playerIds = [];
        let lastClickTime = 0;

        const defaultVideos = [
            'XWjQEpRrgbE',
            '1kx--gAntwE',
            'krUGzTq00Z0',
            'YGNIRYKBqdc'
        ];

        function initApp() {
            const saved = localStorage.getItem('msquare_streams');
            const streamIds = saved ? JSON.parse(saved) : defaultVideos;
            updateSystemState(streamIds);
        }

        function updateSystemState(ids) {
            // Limpa players antigos antes de re-renderizar
            Object.values(players).forEach(p => {
                if (p && typeof p.destroy === 'function') p.destroy();
            });
            players = {};

            playerIds = ids.map((_, i) => `player${i + 1}`);
            renderGrid(ids);

            // Inicializa novos players. 
            // Se a API ainda n√£o estiver pronta, o onYouTubeIframeAPIReady cuidar√° disso.
            if (typeof YT !== 'undefined' && YT.Player) {
                playerIds.forEach(id => createPlayer(id));
                triggerEntranceAnimation();
            }
        }

        function renderGrid(ids) {
            const container = document.getElementById('videoContainer');
            const borders = ['border-primary', 'border-secondary', 'border-tertiary', 'border-gradient'];

            container.innerHTML = ids.map((id, index) => {
                const bClass = borders[index % borders.length];
                return `
                    <div class="video-item ${bClass}" onclick="toggleMute(event, 'player${index + 1}')" ondblclick="toggleFullscreen(event, this)">
                        <div class="video-overlay"></div>
                        <div id="player${index + 1}"></div> 
                    </div>
                `;
            }).join('');
        }

        function renderInputs(ids) {
            const container = document.getElementById('inputContainer');
            container.innerHTML = ids.map((id, index) => `
                <div class="input-group">
                    <label>V√≠deo ${index + 1} (Link ou ID)</label>
                    <div class="input-row">
                        <input type="text" class="stream-input" value="${id}" placeholder="Ex: https://www.youtube.com/watch?v=...">
                        ${ids.length > 1 ? `<button class="btn-remove" onclick="removeStream(${index})">üóë</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function addStream() {
            const inputs = document.querySelectorAll('.stream-input');
            const ids = Array.from(inputs).map(i => i.value.trim());
            ids.push('');
            renderInputs(ids);
        }

        function removeStream(index) {
            const inputs = document.querySelectorAll('.stream-input');
            const ids = Array.from(inputs).map(i => i.value.trim());
            ids.splice(index, 1);
            renderInputs(ids);
        }

        function onYouTubeIframeAPIReady() {
            initApp();
            renderInputs(getSavedIds());
        }

        function getSavedIds() {
            const saved = localStorage.getItem('msquare_streams');
            return saved ? JSON.parse(saved) : defaultVideos;
        }

        function createPlayer(elementId) {
            const videoId = getSavedIds()[parseInt(elementId.replace('player', '')) - 1];
            if (!videoId) return;

            players[elementId] = new YT.Player(elementId, {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,
                    'mute': 1,
                    'enablejsapi': 1,
                    'controls': 0,
                    'rel': 0,
                    'iv_load_policy': 3
                },
                events: {
                    'onReady': (event) => {
                        event.target.mute();
                        event.target.playVideo();
                    },
                    'onStateChange': (event) => {
                        if (event.data === YT.PlayerState.PAUSED) {
                            event.target.playVideo();
                        }
                    }
                }
            });
        }

        function openModal() {
            renderInputs(getSavedIds());
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('settingsModal').style.display = 'none'; }

        function extractYouTubeId(url) {
            if (!url) return '';
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length == 11) ? match[7] : url;
        }

        function saveSettings() {
            const inputs = document.querySelectorAll('.stream-input');
            const newIds = Array.from(inputs)
                .map(i => extractYouTubeId(i.value.trim()))
                .filter(id => id !== '');

            if (newIds.length === 0) {
                alert('Adicione pelo menos um v√≠deo v√°lido.');
                return;
            }

            localStorage.setItem('msquare_streams', JSON.stringify(newIds));
            updateSystemState(newIds);
            closeModal();
        }

        function toggleFullscreen(e, element) {
            if (e) { e.stopPropagation(); }
            const iframe = element.querySelector('iframe');
            if (!document.fullscreenElement) {
                if (element.requestFullscreen) element.requestFullscreen();
                else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();

                if (iframe && players[iframe.id]) {
                    const id = iframe.id;
                    playerIds.forEach(pId => players[pId]?.mute?.());
                    players[id]?.unMute?.();
                    showStatus(id, 'Fullscreen Focus üì∫üîä');
                }
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        function toggleMute(e, id) {
            if (e) { e.stopPropagation(); }
            const now = Date.now();
            if (now - lastClickTime < 300) { lastClickTime = now; return false; }
            lastClickTime = now;

            const targetPlayer = players[id];
            if (!targetPlayer || typeof targetPlayer.isMuted !== 'function') return false;

            const isCurrentlyMuted = targetPlayer.isMuted();
            playerIds.forEach(pId => players[pId]?.mute?.());

            if (isCurrentlyMuted) {
                targetPlayer.unMute();
                targetPlayer.playVideo();
                showStatus(id, 'Audio Focus üîä');
            } else {
                showStatus(id, 'All Muted üîá');
            }
            return false;
        }

        function showStatus(id, text) {
            const container = document.getElementById(id).parentElement;
            let status = container.querySelector('.status-indicator');
            if (!status) {
                status = document.createElement('div');
                status.className = 'status-indicator';
                container.appendChild(status);
            }
            status.textContent = text;
            status.classList.add('visible');
            setTimeout(() => status.classList.remove('visible'), 1500);
        }

        function triggerEntranceAnimation() {
            document.querySelectorAll('.video-item').forEach((item, index) => {
                setTimeout(() => {
                    item.style.opacity = "1";
                    item.style.transform = "scale(1)";
                }, index * 100);
            });
        }
    </script>

</body>

</html>